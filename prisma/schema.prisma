generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum AccountStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum WorkspaceVisibility {
  private
  listed
  public
}

enum WorkspaceMembershipRole {
  owner
  admin
  member
}

enum WorkspaceMembershipStatus {
  active
  invited
  pending
  removed
}

enum FileSystemType {
  folder
  file
}

enum ShareLinkAccess {
  viewer
  commenter
  editor
}

enum ShareLinkAccessType {
  private      // Only accessible with password or specific permissions
  link         // Anyone with the link can access
  public       // Publicly discoverable and accessible
}

enum ExternalCollaboratorStatus {
  active
  suspended
}

enum AuditActorType {
  membership
  external
}

enum ExportJobStatus {
  pending
  processing
  completed
  failed
  cancelled
}

// ============================================================================
// CORE MODELS
// ============================================================================

model Account {
  id                String        @id @default(uuid())
  email             String        @unique
  passwordHash      String        @map("password_hash")
  status            AccountStatus @default(ACTIVE)
  legalName         String?       @map("legal_name")
  recoveryEmail     String?       @map("recovery_email")
  recoveryPhone     String?       @map("recovery_phone")
  preferredTimezone String?       @map("preferred_timezone")
  preferredLocale   String?       @map("preferred_locale")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  sessions          Session[]
  ownedWorkspaces   Workspace[]
  memberships       WorkspaceMembership[]
  sentWorkspaceInvitations WorkspaceInvitation[]
  joinRequests      WorkspaceJoinRequest[]
  passwordResetTokens PasswordResetToken[]
}

model Session {
  id         String    @id @default(uuid())
  account    Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  accountId  String    @map("account_id")
  expiresAt  DateTime  @map("expires_at")
  revokedAt  DateTime? @map("revoked_at")
  revokedReason String? @map("revoked_reason")
  
  // Session metadata
  ipAddress  String?   @map("ip_address")
  userAgent  String?   @map("user_agent")
  browser    String?   // e.g., "Chrome", "Firefox", "Safari"
  os         String?   // e.g., "Windows", "macOS", "Linux"
  device     String?   // e.g., "Desktop", "Mobile", "Tablet"
  
  createdAt  DateTime  @default(now()) @map("created_at")

  @@index([accountId])
}

model Workspace {
  id              String               @id @default(uuid())
  name            String
  description     String?
  visibility      WorkspaceVisibility  @default(private)
  handle          String?              @unique
  owner           Account              @relation(fields: [ownerId], references: [id])
  ownerId         String               @map("owner_id")
  defaultLanguage String?              @map("default_language")
  
  // Workspace-level blog settings
  blogHandle      String?              @unique @map("blog_handle")
  blogDescription String?              @map("blog_description")
  blogTheme       String?              @map("blog_theme")
  
  // Atomic counter for file index
  lastFileIndex   Int                  @default(0) @map("last_file_index")
  
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")
  memberships     WorkspaceMembership[]
  fileSystem      FileSystemEntry[]
  shareLinks      ShareLink[]
  exportJobs      ExportJob[]
  auditLogs       AuditLog[]
  invitations     WorkspaceInvitation[]
  joinRequests    WorkspaceJoinRequest[]

  @@index([ownerId])
}

model WorkspaceMembership {
  id              String                    @id @default(uuid())
  workspace       Workspace                 @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  workspaceId     String                    @map("workspace_id")
  account         Account                   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  accountId       String                    @map("account_id")
  role            WorkspaceMembershipRole
  status          WorkspaceMembershipStatus @default(active)
  displayName     String?                   @map("display_name")
  
  // Member-specific settings per workspace
  locale          String?
  timezone        String?
  
  invitedBy       String?                   @map("invited_by")
  joinedAt        DateTime?                 @map("joined_at")
  
  // Blog fields
  blogHandle      String?                   @unique @map("blog_handle")
  blogDescription String?                   @map("blog_description")
  blogTheme       String?                   @map("blog_theme")
  
  createdAt       DateTime                  @default(now()) @map("created_at")
  updatedAt       DateTime                  @updatedAt @map("updated_at")
  
  createdFiles FileSystemEntry[]         @relation("FileCreator")
  revisions    Revision[]                @relation("RevisionCreator")
  shareLinks   ShareLink[]

  @@unique([workspaceId, accountId])
  @@index([accountId])
  @@index([blogHandle])
}

// ============================================================================
// FILE SYSTEM - UNIFIED MODEL
// ============================================================================

model FileSystemEntry {
  id          String          @id @default(uuid())
  name        String          // Actual filename with extension
  displayName String?         @map("display_name") // User-facing name
  type        FileSystemType
  
  // Hierarchy
  parentId    String?         @map("parent_id")
  parent      FileSystemEntry? @relation("FileSystemHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    FileSystemEntry[] @relation("FileSystemHierarchy")
  
  // Workspace
  workspaceId String
  workspace   Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  // File metadata (type='file' only)
  mimeType    String?         @map("mime_type")
  extension   String?         // Stored separately for sorting/filtering
  size        BigInt?
  
  // Current version
  currentRevisionId String?   @map("current_revision_id")
  currentRevision   Revision? @relation("CurrentRevision", fields: [currentRevisionId], references: [id])
  
  // Metadata
  isStarred   Boolean         @default(false) @map("is_starred")
  isShared    Boolean         @default(false) @map("is_shared") // Indicates if file has any share links
  description String?
  tags        String[]
  viewCount   Int             @default(0) @map("view_count") // type='file' only - tracks document views
  fileIndex   Int?            @map("file_index") // Sequential index per workspace
  
  // Soft delete
  deletedAt   DateTime?       @map("deleted_at")
  deletedBy   String?         @map("deleted_by")
  originalParentId String?    @map("original_parent_id")
  
  // Timestamps & creators
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  createdBy   String          @map("created_by")
  creator     WorkspaceMembership @relation("FileCreator", fields: [createdBy], references: [id])
  lastModifiedBy String?      @map("last_modified_by")
  
  // Relations
  revisions   Revision[]      @relation("FileRevisions")
  shareLinks  ShareLink[]
  exportJobs  ExportJob[]
  
  @@index([workspaceId, parentId])
  @@index([workspaceId, deletedAt])
  @@index([type])
  @@index([mimeType])
  @@index([isStarred])
  @@unique([workspaceId, fileIndex])
  @@map("file_system")
}

// ============================================================================
// REVISION SYSTEM - UNIVERSAL FOR ALL FILES
// ============================================================================

model Revision {
  id          String          @id @default(uuid())
  fileId      String          @map("file_id")
  file        FileSystemEntry @relation("FileRevisions", fields: [fileId], references: [id], onDelete: Cascade)
  
  // S3 storage
  storageKey  String          @map("storage_key")  // v1, v2, v3... (latest는 별도)
  size        BigInt
  version     Int
  
  // Change tracking
  changeNote  String?         @map("change_note")
  
  // Creator
  createdAt   DateTime        @default(now()) @map("created_at")
  createdBy   String          @map("created_by")
  creator     WorkspaceMembership @relation("RevisionCreator", fields: [createdBy], references: [id])
  
  // Files using this as current
  currentForFiles FileSystemEntry[] @relation("CurrentRevision")
  
  @@unique([fileId, version])
  @@index([fileId, version])
  @@map("revisions")
}

// ============================================================================
// SHARING
// ============================================================================

model ShareLink {
  id            String              @id @default(uuid())
  token         String              @unique
  
  fileId        String              @map("file_id")
  file          FileSystemEntry     @relation(fields: [fileId], references: [id], onDelete: Cascade)
  
  workspaceId   String              @map("workspace_id")
  workspace     Workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  accessLevel   ShareLinkAccess     @map("access_level") @default(viewer)
  accessType    ShareLinkAccessType @map("access_type") @default(link)
  passwordHash  String?             @map("password_hash")
  expiresAt     DateTime?           @map("expires_at")
  revokedAt     DateTime?           @map("revoked_at")
  
  createdAt     DateTime            @default(now()) @map("created_at")
  createdBy     String              @map("created_by")
  creator       WorkspaceMembership @relation(fields: [createdBy], references: [id])
  
  sessions      ShareLinkSession[]
  
  @@index([fileId])
  @@index([workspaceId])
  @@map("share_links")
}

model ExternalCollaborator {
  id           String                      @id @default(uuid())
  email        String                      @unique
  displayName  String?                     @map("display_name")
  status       ExternalCollaboratorStatus  @default(active)
  createdAt    DateTime                    @default(now()) @map("created_at")
  updatedAt    DateTime                    @updatedAt @map("updated_at")
  sessions     ShareLinkSession[]
}

model ShareLinkSession {
  id               String               @id @default(uuid())
  shareLink        ShareLink            @relation(fields: [shareLinkId], references: [id], onDelete: Cascade)
  shareLinkId      String               @map("share_link_id")
  collaborator     ExternalCollaborator @relation(fields: [collaboratorId], references: [id], onDelete: Cascade)
  collaboratorId   String               @map("collaborator_id")
  tokenHash        String               @map("token_hash") @unique
  expiresAt        DateTime             @map("expires_at")
  revokedAt        DateTime?            @map("revoked_at")
  createdAt        DateTime             @default(now()) @map("created_at")

  @@index([shareLinkId])
  @@index([collaboratorId])
  @@map("share_link_sessions")
}

// ============================================================================
// EXPORT & AUDIT
// ============================================================================

model ExportJob {
  id            String          @id @default(uuid())
  workspace     Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  workspaceId   String          @map("workspace_id")
  
  file          FileSystemEntry? @relation(fields: [fileId], references: [id])
  fileId        String?         @map("file_id")
  
  format        String
  status        ExportJobStatus @default(pending)
  resultUrl     String?         @map("result_url")
  errorMessage  String?         @map("error_message")
  retryCount    Int             @default(0) @map("retry_count")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  @@index([workspaceId])
  @@map("export_jobs")
}

model AuditLog {
  id                 String          @id @default(uuid())
  workspace          Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  workspaceId        String          @map("workspace_id")
  actorType          AuditActorType  @map("actor_type")
  actorMembershipId  String?         @map("actor_membership_id")
  actorCollaboratorId String?        @map("actor_collaborator_id")
  action             String
  entityType         String          @map("entity_type")
  entityId           String?         @map("entity_id")
  metadata           Json?           @map("metadata")
  createdAt          DateTime        @default(now()) @map("created_at")

  @@index([workspaceId, createdAt])
  @@index([actorMembershipId])
  @@index([actorCollaboratorId])
  @@map("audit_logs")
}

model PasswordResetToken {
  id          String   @id @default(uuid())
  account     Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  accountId   String   @map("account_id")
  tokenHash   String   @unique @map("token_hash")
  expiresAt   DateTime @map("expires_at")
  usedAt      DateTime? @map("used_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([accountId])
  @@map("password_reset_tokens")
}

// ============================================================================
// WORKSPACE INVITATION & JOIN REQUESTS
// ============================================================================

model WorkspaceInvitation {
  id          String   @id @default(uuid())
  workspaceId String   @map("workspace_id")
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  email       String
  tokenHash   String   @unique @map("token_hash")
  status      String   @default("pending") // pending, accepted, cancelled
  invitedBy   String   @map("invited_by")
  invitedByAccount Account @relation(fields: [invitedBy], references: [id])
  
  expiresAt   DateTime @map("expires_at")
  resentCount Int      @default(0) @map("resent_count")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([workspaceId])
  @@index([email])
  @@map("workspace_invitations")
}

model WorkspaceJoinRequest {
  id          String   @id @default(uuid())
  workspaceId String   @map("workspace_id")
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  accountId   String   @map("account_id")
  account     Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  status      String   @default("pending") // pending, approved, rejected
  message     String?
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([workspaceId, accountId])
  @@index([workspaceId])
  @@index([accountId])
  @@map("workspace_join_requests")
}
