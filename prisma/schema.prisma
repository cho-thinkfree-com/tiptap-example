generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum WorkspaceVisibility {
  private
  listed
  public
}

enum WorkspaceMembershipRole {
  owner
  admin
  member
}

enum WorkspaceMembershipStatus {
  active
  invited
  pending
  removed
}

enum DocumentStatus {
  draft
  published
  archived
}

enum DocumentVisibility {
  private
  workspace
  shared
  public
}

enum DocumentWorkspaceAccess {
  none
  viewer
  commenter
  editor
}

enum DocumentPermissionRole {
  viewer
  commenter
  editor
}

enum DocumentPermissionPrincipalType {
  workspace
  membership
  account
  share_link
}

enum DocumentShareLinkAccess {
  viewer
  commenter
}

enum ExternalCollaboratorStatus {
  active
  suspended
}

enum AuditActorType {
  membership
  external
}

enum ExportJobStatus {
  pending
  processing
  completed
  failed
  cancelled
}

model Account {
  id            String        @id @default(uuid())
  email         String        @unique
  passwordHash  String        @map("password_hash")
  status        AccountStatus @default(ACTIVE)
  legalName     String?       @map("legal_name")
  recoveryEmail String?       @map("recovery_email")
  recoveryPhone String?       @map("recovery_phone")
  preferredTimezone String?   @map("preferred_timezone")
  preferredLocale String?     @map("preferred_locale")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  sessions      Session[]
  passwordResetTokens PasswordResetToken[]
  ownedWorkspaces   Workspace[] @relation("WorkspaceOwner")
  memberships    WorkspaceMembership[]
  joinRequests   WorkspaceJoinRequest[]
}

model Session {
  id               String   @id @default(uuid())
  accountId        String   @map("account_id")
  account          Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  expiresAt        DateTime @map("expires_at")
  createdAt        DateTime @default(now()) @map("created_at")
  revokedAt        DateTime? @map("revoked_at")
  revokedReason    String?  @map("revoked_reason")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  accountId String   @map("account_id")
  account   Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  tokenHash String   @map("token_hash") @unique
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")
}

model Workspace {
  id             String              @id @default(uuid())
  name           String
  slug           String              @unique
  description    String?
  coverImage     String?             @map("cover_image")
  defaultLocale  String              @map("default_locale") @default("en")
  defaultTimezone String             @map("default_timezone") @default("UTC")
  visibility     WorkspaceVisibility @default(private)
  ownerAccountId String              @map("owner_account_id")
  allowedDomains Json?               @map("allowed_domains")
  owner          Account             @relation("WorkspaceOwner", fields: [ownerAccountId], references: [id], onDelete: Cascade)
  createdAt      DateTime            @default(now()) @map("created_at")
  updatedAt      DateTime            @updatedAt @map("updated_at")
  deletedAt      DateTime?           @map("deleted_at")
  memberships    WorkspaceMembership[]
  invitations    WorkspaceInvitation[]
  joinRequests   WorkspaceJoinRequest[]
  folders        Folder[]
  documents      Document[]
  exportJobs     ExportJob[]
  auditLogs      AuditLog[]
}

model WorkspaceMembership {
  id          String                   @id @default(uuid())
  workspace   Workspace                @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  workspaceId String                   @map("workspace_id")
  account     Account                  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  accountId   String                   @map("account_id")
  role        WorkspaceMembershipRole  @default(member)
  status      WorkspaceMembershipStatus @default(active)
  displayName String?                  @map("display_name")
  avatarUrl   String?                  @map("avatar_url")
  timezone    String?                  @map("timezone")
  preferredLocale String?              @map("preferred_locale")
  blogTheme   String?                  @map("blog_theme") @default("modern")
  blogHandle  String?                  @unique @map("blog_handle")
  blogDescription String?              @map("blog_description")
  notifications Json?                  @map("notification_settings")
  createdAt   DateTime                 @default(now()) @map("created_at")
  updatedAt   DateTime                 @updatedAt @map("updated_at")
  ownedDocuments Document[]            @relation("DocumentOwner")
  revisionHistory DocumentRevision[]   @relation("RevisionAuthor")
  documentPermissions DocumentPermission[] @relation("DocumentPermissionMembership")
  createdShareLinks DocumentShareLink[]

  @@unique([workspaceId, accountId])
}

model WorkspaceInvitation {
  id          String    @id @default(uuid())
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  workspaceId String    @map("workspace_id")
  email       String
  tokenHash   String    @map("token_hash") @unique
  status      String    @default("pending")
  invitedBy   String    @map("invited_by")
  expiresAt   DateTime  @map("expires_at")
  resentCount Int       @map("resent_count") @default(0)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
}

model WorkspaceJoinRequest {
  id          String    @id @default(uuid())
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  workspaceId String    @map("workspace_id")
  account     Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  accountId   String    @map("account_id")
  status      String    @default("pending")
  message     String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
}

model Folder {
  id          String     @id @default(uuid())
  workspace   Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  workspaceId String     @map("workspace_id")
  parentId    String?    @map("parent_id")
  parent      Folder?    @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    Folder[]   @relation("FolderHierarchy")
  name        String
  pathCache   String     @map("path_cache")
  sortOrder   Int        @map("sort_order") @default(0)
  deletedAt   DateTime?  @map("deleted_at")
  deletedBy   String?    @map("deleted_by")
  originalParentId String? @map("original_parent_id")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  documents   Document[]
  tags        FolderTag[]
  isImportant Boolean    @default(false) @map("is_important")

  @@index([workspaceId])
  @@index([workspaceId, parentId])
}

model Document {
  id                 String               @id @default(uuid())
  workspace          Workspace            @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  workspaceId        String               @map("workspace_id")
  folder             Folder?              @relation(fields: [folderId], references: [id], onDelete: SetNull)
  folderId           String?              @map("folder_id")
  ownerMembership    WorkspaceMembership  @relation("DocumentOwner", fields: [ownerMembershipId], references: [id])
  ownerMembershipId  String               @map("owner_membership_id")
  title              String
  slug               String
  documentNumber     Int?                 @map("document_number")
  status             DocumentStatus       @default(draft)
  visibility         DocumentVisibility   @default(private)
  summary            String?              @map("summary")
  contentSize        Int                  @map("content_size") @default(0)
  sortOrder          Int                  @map("sort_order") @default(0)
  workspaceDefaultAccess DocumentWorkspaceAccess @map("workspace_default_access") @default(none)
  workspaceEditorAdminsOnly Boolean @map("workspace_editor_admins_only") @default(false)
  deletedAt          DateTime?            @map("deleted_at")
  deletedBy          String?              @map("deleted_by")
  originalFolderId   String?              @map("original_folder_id")
  createdAt          DateTime             @default(now()) @map("created_at")
  updatedAt          DateTime             @updatedAt @map("updated_at")
  revisions          DocumentRevision[]
  permissions        DocumentPermission[]
  shareLinks         DocumentShareLink[]
  exportJobs         ExportJob[]
  tags               DocumentTag[]
  isImportant        Boolean              @default(false) @map("is_important")
  viewCount          Int                  @default(0) @map("view_count")

  @@unique([workspaceId, slug])
  @@unique([workspaceId, documentNumber])
  @@index([workspaceId, folderId])
  @@index([ownerMembershipId])
}

model ExportJob {
  id           String          @id @default(uuid())
  workspace    Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  workspaceId  String          @map("workspace_id")
  document     Document?       @relation(fields: [documentId], references: [id])
  documentId   String?         @map("document_id")
  format       String
  status       ExportJobStatus @default(pending)
  resultUrl    String?         @map("result_url")
  errorMessage String?         @map("error_message")
  retryCount   Int             @default(0) @map("retry_count")
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")

  @@index([workspaceId])
}

model DocumentTag {
  id          String   @id @default(uuid())
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentId  String   @map("document_id")
  name        String
  createdAt   DateTime @default(now()) @map("created_at")

  @@unique([documentId, name])
  @@index([documentId])
}

model FolderTag {
  id          String   @id @default(uuid())
  folder      Folder   @relation(fields: [folderId], references: [id], onDelete: Cascade)
  folderId    String   @map("folder_id")
  name        String
  createdAt   DateTime @default(now()) @map("created_at")

  @@unique([folderId, name])
  @@index([folderId])
}

model DocumentRevision {
  id                    String              @id @default(uuid())
  document              Document            @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentId            String              @map("document_id")
  version               Int
  contentSize           Int                  @map("content_size") @default(0)
  content               Json                @map("content")
  summary               String?             @map("summary")
  createdByMembership   WorkspaceMembership @relation("RevisionAuthor", fields: [createdByMembershipId], references: [id])
  createdByMembershipId String              @map("created_by_membership_id")
  createdAt             DateTime            @default(now()) @map("created_at")

  @@unique([documentId, version])
}

model DocumentPermission {
  id            String                         @id @default(uuid())
  document      Document                       @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentId    String                         @map("document_id")
  principalType DocumentPermissionPrincipalType @map("principal_type")
  principalId   String                         @map("principal_id")
  membershipId  String?                        @map("membership_id")
  membership    WorkspaceMembership?           @relation("DocumentPermissionMembership", fields: [membershipId], references: [id], onDelete: Cascade)
  role          DocumentPermissionRole
  createdAt     DateTime                       @default(now()) @map("created_at")
  updatedAt     DateTime                       @updatedAt @map("updated_at")

  @@unique([documentId, principalType, principalId])
  @@index([membershipId])
}

model DocumentShareLink {
  id                  String                 @id @default(uuid())
  document            Document               @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentId          String                 @map("document_id")
  token               String                 @unique
  accessLevel         DocumentShareLinkAccess @map("access_level")
  passwordHash        String?                @map("password_hash")
  expiresAt           DateTime?              @map("expires_at")
  revokedAt           DateTime?              @map("revoked_at")
  createdByMembership WorkspaceMembership    @relation(fields: [createdByMembershipId], references: [id], onDelete: Cascade)
  createdByMembershipId String               @map("created_by_membership_id")
  allowExternalEdit   Boolean                @map("allow_external_edit") @default(false)
  isPublic            Boolean                @map("is_public") @default(false)
  sessions            DocumentShareLinkSession[]
  createdAt           DateTime               @default(now()) @map("created_at")

  @@index([documentId])
}

model ExternalCollaborator {
  id           String                      @id @default(uuid())
  email        String                      @unique
  displayName  String?                     @map("display_name")
  status       ExternalCollaboratorStatus  @default(active)
  createdAt    DateTime                    @default(now()) @map("created_at")
  updatedAt    DateTime                    @updatedAt @map("updated_at")
  sessions     DocumentShareLinkSession[]
}

model DocumentShareLinkSession {
  id               String             @id @default(uuid())
  shareLink        DocumentShareLink  @relation(fields: [shareLinkId], references: [id], onDelete: Cascade)
  shareLinkId      String             @map("share_link_id")
  collaborator     ExternalCollaborator @relation(fields: [collaboratorId], references: [id], onDelete: Cascade)
  collaboratorId   String             @map("collaborator_id")
  tokenHash        String             @map("token_hash") @unique
  expiresAt        DateTime           @map("expires_at")
  revokedAt        DateTime?          @map("revoked_at")
  createdAt        DateTime           @default(now()) @map("created_at")

  @@index([shareLinkId])
  @@index([collaboratorId])
}

model AuditLog {
  id                 String          @id @default(uuid())
  workspace          Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  workspaceId        String          @map("workspace_id")
  actorType          AuditActorType  @map("actor_type")
  actorMembershipId  String?         @map("actor_membership_id")
  actorCollaboratorId String?        @map("actor_collaborator_id")
  action             String
  entityType         String          @map("entity_type")
  entityId           String?         @map("entity_id")
  metadata           Json?           @map("metadata")
  createdAt          DateTime        @default(now()) @map("created_at")

  @@index([workspaceId, createdAt])
  @@index([actorMembershipId])
  @@index([actorCollaboratorId])
}
